<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Đặt lại mật khẩu</title>
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./public/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./public/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./public/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="./public/favicon/site.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Trang đặt lại mật khẩu" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/index.css" />
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/components.css" />
    <link rel="stylesheet" href="./css/login.css" />
    <style>
      /* Custom styles for the reset password page */
      .log-in {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh; /* Ensure it takes full viewport height */
        padding: 50px 20px; /* Add some padding */
        background-color: var(
          --gray_50_01
        ); /* Use background from login page */
        box-sizing: border-box; /* Include padding in element's total width and height */
      }

      .group-572 {
        margin-top: 0; /* Override default margin-top */
        padding-left: 0;
        padding-right: 0;
        display: flex;
        justify-content: center;
        width: 100%;
      }

      .group-955 {
        display: flex;
        justify-content: center; /* Center the single column */
        align-items: flex-start;
        max-width: 600px; /* Limit width for better appearance */
        width: 100%;
        margin: 0; /* Remove negative margins if any */
        gap: 0;
        flex-direction: column; /* Ensure it stacks correctly on all screens */
      }

      .group-556 {
        width: 100%; /* Make it full width within its container */
        border-right: none; /* Remove right border */
        padding-right: 0; /* Remove right padding */
        display: flex;
        flex-direction: column;
        align-items: center; /* Center content horizontally */
        background-color: var(
          --white_a700_01
        ); /* White background for the form area */
        border-radius: var(--radius-2xl); /* Rounded corners */
        box-shadow: var(--shadow-sm); /* Add subtle shadow */
        padding: var(--space-10xl); /* Add internal padding */
        box-sizing: border-box;
      }

      .frame-57 {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .group-5 {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-xl);
      }

      .frame-51 {
        width: 100%;
        display: flex;
        justify-content: center;
        margin-bottom: var(--space-10xl);
      }

      .ng-nh-p {
        text-align: center;
        color: var(--pink_400); /* Ensure heading color is consistent */
      }

      .group-553 {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-md);
      }

      .form-field {
        width: 80%; /* Match input width */
        margin-bottom: var(--space-md); /* Space between fields */
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Align labels to the left */
      }

      .form-field label {
        margin-bottom: 4px; /* Small space between label and input */
        color: var(--pink_400) !important; /* Keep label color consistent */
      }

      .login-input {
        width: 100%; /* Make inputs fill the form-field width */
        border: none;
        border-bottom: 1px solid var(--pink_400);
        background-color: transparent;
        padding: 8px 0;
        font-size: var(--text-lg);
        color: var(--black_900_01);
        outline: none;
      }

      .login-input:focus {
        border-bottom: 2px solid var(--pink_500);
      }

      #errorMessage {
        color: var(--red_700); /* Use a specific red for errors */
        margin-bottom: 15px;
        width: 80%;
        text-align: center;
        font-size: var(--text-md);
      }

      .frame-56-1.login-button {
        /* Apply existing button styles */
        width: 80%;
        padding-left: var(--space-14xl);
        padding-right: var(--space-14xl);
        font-size: 15px;
        font-weight: 700;
        background-color: var(--red_50) !important;
        color: var(--pink_400) !important;
        height: 34px;
        border-radius: 10px !important;
        border: 1px solid var(--purple_100_01);
        cursor: pointer;
        margin-top: var(--space-lg); /* Adjust margin for button */
      }

      .signup-link.frame-60 {
        /* Style the back to login link */
        width: 80%;
        text-align: center;
        margin-top: var(--space-8xl); /* Space above the link */
        color: var(--black_900_01) !important;
        font-family: "Lexend Deca";
        font-size: 12px;
        font-weight: 500;
        gap: var(--space-2xl);
        height: 32px;
        min-width: 190px;
        border-radius: 10px !important;
        border: 1px solid var(--blue_gray_100) !important;
        display: flex;
        justify-content: center;
        align-items: center;
        text-decoration: none; /* Remove underline */
      }

      /* Custom Alert Modal Styles */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
        justify-content: center;
        align-items: center;
        font-family: "Lexend Deca", sans-serif;
      }

      .modal-content {
        background-color: #fefefe;
        padding: 30px;
        border: 1px solid #888;
        width: 90%;
        max-width: 400px;
        border-radius: 15px;
        text-align: center;
        position: relative;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        animation: fadeInScale 0.3s ease-out;
      }

      .close-button {
        color: #aaa;
        font-size: 32px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 15px;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .close-button:hover,
      .close-button:focus {
        color: var(--pink_400);
        text-decoration: none;
      }

      #customAlertMessage {
        font-size: 18px;
        color: var(--black_900_01);
        margin-bottom: 25px;
        line-height: 1.5;
      }

      .modal-button {
        background-color: var(--pink_400);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.2s ease;
      }

      .modal-button:hover {
        background-color: var(--red_900);
      }

      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Responsive adjustments for smaller screens */
      @media only screen and (max-width: 1050px) {
        .group-955 {
          max-width: 500px;
        }
        .group-556 {
          padding: var(--space-8xl);
        }
        .form-field,
        .frame-56-1.login-button,
        .signup-link.frame-60 {
          width: 90%;
        }
      }

      @media only screen and (max-width: 550px) {
        .log-in {
          padding: 30px 15px;
        }
        .group-556 {
          padding: var(--space-5xl);
        }
        .ng-nh-p.ui.text.size-text7xl {
          font-size: 28px;
        }
        .name.ui.text.size-text4xl {
          font-size: 18px;
        }
        .login-input {
          font-size: 16px;
        }
        .frame-56-1.login-button {
          font-size: 14px;
          padding: 10px 20px;
        }
        .signup-link.frame-60 {
          font-size: 11px;
          padding: 8px 15px;
        }
        .form-field,
        .frame-56-1.login-button,
        .signup-link.frame-60 {
          width: 95%;
        }
        #customAlertMessage {
          font-size: 16px;
        }
        .modal-button {
          padding: 10px 20px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="log-in">
      <div class="group-572">
        <div class="group-955">
          <div class="group-556">
            <div class="frame-57">
              <div class="group-5">
                <div class="frame-51">
                  <p class="ng-nh-p ui text size-text7xl">Tạo mật khẩu mới</p>
                </div>
                <div class="group-553">
                  <form
                    id="resetPasswordForm"
                    style="
                      width: 100%;
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                    "
                  >
                    <input type="hidden" id="token" name="token" />

                    <div class="form-field">
                      <label for="email" class="name ui text size-text4xl"
                        >Email</label
                      >
                      <input
                        type="email"
                        id="email"
                        name="email"
                        class="login-input"
                        readonly
                      />
                    </div>
                    <div class="form-field">
                      <label for="password" class="name ui text size-text4xl"
                        >Mật khẩu mới</label
                      >
                      <input
                        type="password"
                        id="password"
                        name="password"
                        class="login-input"
                        required
                      />
                    </div>
                    <div class="form-field">
                      <label
                        for="password_confirmation"
                        class="name ui text size-text4xl"
                        >Xác nhận mật khẩu</label
                      >
                      <input
                        type="password"
                        id="password_confirmation"
                        name="password_confirmation"
                        class="login-input"
                        required
                      />
                    </div>
                    <p id="errorMessage"></p>
                    <button
                      type="submit"
                      class="frame-56-1 ui button red_50 size-lg fill login-button"
                    >
                      ĐẶT LẠI MẬT KHẨU
                    </button>
                    <a
                      href="login.html"
                      class="signup-link frame-60 ui button blue_gray_100 size-md outline"
                      >← Quay lại đăng nhập</a
                    >
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="customAlertModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <p id="customAlertMessage"></p>
        <button id="customAlertOkButton" class="modal-button">OK</button>
      </div>
    </div>

    <script>
      // Function to show custom alert modal
      function showCustomAlert(message) {
        const modal = document.getElementById("customAlertModal");
        const messageElement = document.getElementById("customAlertMessage");
        const closeButton = document.querySelector(
          "#customAlertModal .close-button"
        );
        const okButton = document.getElementById("customAlertOkButton");

        messageElement.textContent = message;
        modal.style.display = "flex"; // Use flex to center the modal

        const closeAlert = () => {
          modal.style.display = "none";
          // Remove event listeners to prevent memory leaks
          closeButton.removeEventListener("click", closeAlert);
          okButton.removeEventListener("click", closeAlert);
          modal.removeEventListener("click", handleOutsideClick);
        };

        const handleOutsideClick = (e) => {
          if (e.target === modal) {
            closeAlert();
          }
        };

        closeButton.addEventListener("click", closeAlert);
        okButton.addEventListener("click", closeAlert);
        modal.addEventListener("click", handleOutsideClick); // Listen for clicks outside content
      }

      // Get token and email from URL when the page loads
      window.onload = function () {
        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");
        const email = params.get("email");

        if (!token || !email) {
          // Display an error message if token or email are missing
          document.body.innerHTML =
            "<div style=\"display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; font-family: 'Lexend Deca', sans-serif; color: var(--pink_400); font-size: 24px;\"><h1>Đường dẫn không hợp lệ hoặc đã hết hạn.</h1></div>";
          return;
        }

        document.getElementById("token").value = token;
        document.getElementById("email").value = email;
      };

      // Handle form submission
      document
        .getElementById("resetPasswordForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent default form submission

          const form = event.target;
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          const errorMessageDiv = document.getElementById("errorMessage"); // Corrected ID
          errorMessageDiv.textContent = ""; // Clear previous error messages
          const button = form.querySelector("button[type='submit']"); // Select the submit button

          // Validate password confirmation
          if (data.password !== data.password_confirmation) {
            errorMessageDiv.textContent = "Mật khẩu nhập lại không khớp.";
            return;
          }

          // Disable button and show loading text
          button.disabled = true;
          button.textContent = "ĐANG XỬ LÝ...";

          try {
            const response = await fetch(
              "http://127.0.0.1:8000/api/reset-password",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                },
                body: JSON.stringify(data),
              }
            );

            const result = await response.json();

            if (!response.ok) {
              let errorText = result.message || "Có lỗi xảy ra.";
              if (result.errors) {
                // Concatenate all error messages from the 'errors' object
                errorText = Object.values(result.errors).flat().join("\n");
              }
              throw new Error(errorText);
            }

            showCustomAlert(result.message); // "Mật khẩu đã được đặt lại thành công!"
            // Redirect to login page after a short delay for the user to read the message
            setTimeout(() => {
              window.location.href = "Login.html";
            }, 2000); // Redirect after 2 seconds
          } catch (error) {
            errorMessageDiv.textContent = error.message;
          } finally {
            // Re-enable button and restore original text
            button.disabled = false;
            button.textContent = "ĐẶT LẠI MẬT KHẨU";
          }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      // Hàm hiển thị thông báo tùy chỉnh bằng SweetAlert2
      function showCustomAlert(
        icon,
        title,
        text,
        confirmButtonColor = "var(--pink_400)"
      ) {
        Swal.fire({
          icon: icon, // 'success', 'error', 'warning', 'info', 'question'
          title: title,
          text: text,
          confirmButtonColor: confirmButtonColor,
          customClass: {
            confirmButton: "swal2-confirm-button", // Thêm class để tùy chỉnh thêm nếu cần
          },
          // Bạn có thể thêm các tùy chỉnh khác ở đây, ví dụ:
          // background: '#fefefe',
          // color: '#333',
          // showCloseButton: true,
          // timer: 3000, // Tự động đóng sau 3 giây
          // timerProgressBar: true,
        });
      }
    </script>
  </body>
</html>
